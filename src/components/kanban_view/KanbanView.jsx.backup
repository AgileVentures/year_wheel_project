import { useState, useMemo, useEffect } from 'react';
import { ChevronDown, Plus, X, Eye, EyeOff, Filter } from 'lucide-react';
import { useTranslation } from 'react-i18next';
import { format } from 'date-fns';
import { sv, enUS } from 'date-fns/locale';
import ItemTooltip from '../ItemTooltip';
import AddItemModal from '../AddItemModal';

/**
 * KanbanView - Dead Simple Version
 * No refs, no memo, no optimization - just pure React state
 */
const KanbanView = ({
  wheelStructure,
  year,
  pages = [],
  onUpdateItem,
  onDeleteItem,
  onAddItems,
  onOrganizationChange,
  onNavigateToItemOnWheel,
  currentWheelId,
  currentPageId
}) => {
  const { t, ready } = useTranslation();
  
  const { rings = [], activityGroups = [], labels = [] } = wheelStructure || {};
  const items = wheelStructure?.items || [];
  
  // Simple state - nothing fancy
  const [collapsedColumns, setCollapsedColumns] = useState({ unlabeled: false });
  const [editingItem, setEditingItem] = useState(null);
  const [tooltipPosition, setTooltipPosition] = useState({ x: 0, y: 0 });
  const [addItemLabelId, setAddItemLabelId] = useState(null);
  const [draggedItem, setDraggedItem] = useState(null);
  
  // Initialize collapsed state for labels once
  useEffect(() => {
    const newState = { unlabeled: false };
    labels.forEach(label => {
      if (!(label.id in collapsedColumns)) {
        newState[label.id] = true;
      } else {
        newState[label.id] = collapsedColumns[label.id];
      }
    });
    setCollapsedColumns(newState);
  }, [labels.map(l => l.id).join(',')]); // Only when label IDs change  }, [labels.map(l => l.id).join(',')]); // Only when label IDs change
  
  // Group items by label
  const itemsByLabel = useMemo(() => {
    const grouped = new Map();
    labels.forEach(label => { if (label.visible) grouped.set(label.id, []); });
    grouped.set('unlabeled', []);
    items.forEach(item => {
      const labelId = item.labelId || 'unlabeled';
      if (grouped.has(labelId)) grouped.get(labelId).push(item);
      else grouped.get('unlabeled').push(item);
    });
    return grouped;
  }, [items, labels]);
  
  // Drag handlers - simple state updates
  const handleDragStart = (e, item) => {
    setDraggedItem(item);
  };
  
  const handleDrop = (e, targetLabelId) => {
    e.preventDefault();
    if (!draggedItem) return;
    
    const newLabelId = targetLabelId === 'unlabeled' ? null : targetLabelId;
    if (draggedItem.labelId !== newLabelId) {
      onUpdateItem?.({ ...draggedItem, labelId: newLabelId });
    }
    setDraggedItem(null);
  };
  
  const toggleColumn = (labelId) => {
    setCollapsedColumns(prev => ({ ...prev, [labelId]: !prev[labelId] }));
  };
  
  const getActivityGroup = (activityId) => activityGroups.find(ag => ag.id === activityId);
  const getRing = (ringId) => rings.find(r => r.id === ringId);
  
  // Check if labels exist and show setup modal on first load
  useEffect(() => {
    const hasLabels = labels && labels.length > 0;
    const storedConfig = localStorage.getItem(`kanban-config-${currentWheelId}`);
    
    if (!hasLabels && !storedConfig) {
      setShowSetupModal(true);
    } else if (storedConfig) {
      setHasConfigured(true);
    }
  }, [currentWheelId, labels]);
  
  // Get all items from all pages
  const allItems = useMemo(() => {
    return pages.flatMap(page => (page.items || []).map(item => ({
      ...item,
      _pageYear: parseInt(page.year, 10)
    })));
  }, [pages]);
  
  // Group items by label
  const itemsByLabel = useMemo(() => {
    const grouped = new Map();
    
    // Initialize with all labels
    labels.forEach(label => {
      if (label.visible) {
        grouped.set(label.id, []);
      }
    });
    
    // Add unlabeled group
    grouped.set('unlabeled', []);
    
    // Group items
    allItems.forEach(item => {
      if (item.labelId && grouped.has(item.labelId)) {
        grouped.get(item.labelId).push(item);
      } else {
        grouped.get('unlabeled').push(item);
      }
    });
    
    return grouped;
  }, [allItems, labels]);
  
  // Handle label creation with suggested defaults
  const handleCreateDefaultLabels = () => {
    const defaultLabels = [
      { name: 'Kanske', color: '#94A3B8' },
      { name: 'Intressant', color: '#60A5FA' },
      { name: 'Kommer arbeta p√•', color: '#FBBF24' },
      { name: 'P√•g√•r', color: '#F59E0B' },
      { name: 'Klart', color: '#10B981' },
      { name: 'Avvisat', color: '#EF4444' }
    ];
    
    const newLabels = defaultLabels.map((label, index) => ({
      id: `label-${Date.now()}-${index}`,
      name: label.name,
      color: label.color,
      visible: true,
      createdAt: new Date().toISOString()
    }));
    
    if (onOrganizationChange) {
      onOrganizationChange({
        ...wheelStructure,
        labels: [...labels, ...newLabels]
      });
    }
    
    localStorage.setItem(`kanban-config-${currentWheelId}`, JSON.stringify({ configured: true }));
    setHasConfigured(true);
    setShowSetupModal(false);
  };
  
  // Toggle column collapse - update ref and force re-render
  const toggleColumn = (labelId) => {
    collapsedColumnsRef.current[labelId] = !collapsedColumnsRef.current[labelId];
    forceUpdate({});
  };
  
  // Drag and drop handlers
  const handleDragStart = (e, item) => {
    draggedItemRef.current = item;
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/html', e.currentTarget);
    e.currentTarget.style.opacity = '0.5';
  };
  
  const handleDragEnd = (e) => {
    draggedItemRef.current = null;
    e.currentTarget.style.opacity = '1';
  };
  
  const handleColumnDragStart = (e, columnId) => {
    draggedColumnRef.current = columnId;
    e.dataTransfer.effectAllowed = 'move';
    e.currentTarget.style.opacity = '0.5';
  };
  
  const handleColumnDragEnd = (e) => {
    draggedColumnRef.current = null;
    e.currentTarget.style.opacity = '1';
  };
  
  const handleColumnDragOver = (e, targetColumnId) => {
    e.preventDefault();
    if (draggedColumnRef.current && draggedColumnRef.current !== targetColumnId) {
      e.dataTransfer.dropEffect = 'move';
    }
  };
  
  const handleColumnDrop = (e, targetColumnId) => {
    e.preventDefault();
    e.stopPropagation();
    
    const draggedColumn = draggedColumnRef.current;
    if (!draggedColumn || draggedColumn === targetColumnId) {
      return;
    }
    
    // Reorder columns
    const currentOrder = orderedColumns.map(col => col.id);
    const draggedIndex = currentOrder.indexOf(draggedColumn);
    const targetIndex = currentOrder.indexOf(targetColumnId);
    
    if (draggedIndex === -1 || targetIndex === -1) {
      return;
    }
    
    const newOrder = [...currentOrder];
    newOrder.splice(draggedIndex, 1);
    newOrder.splice(targetIndex, 0, draggedColumn);
    
    // Save to ref and localStorage
    columnOrderRef.current = newOrder.filter(id => id !== 'unlabeled');
    localStorage.setItem(`kanban-column-order-${currentWheelId}`, JSON.stringify(columnOrderRef.current));
    forceUpdate({});
  };
  
  const handleDragOver = (e, labelId) => {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
    // Add visual feedback via CSS class
    e.currentTarget.classList.add('drag-over');
  };
  
  const handleDragLeave = (e) => {
    e.currentTarget.classList.remove('drag-over');
  };
  
  const handleDrop = (e, targetLabelId) => {
    e.preventDefault();
    e.stopPropagation();
    e.currentTarget.classList.remove('drag-over');
    
    const item = draggedItemRef.current;
    
    // Check if the item's label is actually changing
    const currentLabelId = item?.labelId;
    const newLabelId = targetLabelId === 'unlabeled' ? null : targetLabelId;
    
    if (!item || currentLabelId === newLabelId) {
      return;
    }
    
    // Update item with new label
    const updatedItem = { ...item, labelId: newLabelId };
    
    // Call parent update - parent will trigger re-render with new data
    if (onUpdateItem) {
      onUpdateItem(updatedItem);
    }
  };
  
  // Get gradient style for column based on label color
  const getColumnGradient = (color) => {
    if (!color) return 'bg-gray-50';
    
    // Create a lighter version for gradient
    const rgb = hexToRgb(color);
    if (!rgb) return 'bg-gray-50';
    
    const lighterRgb = {
      r: Math.min(255, rgb.r + 40),
      g: Math.min(255, rgb.g + 40),
      b: Math.min(255, rgb.b + 40)
    };
    
    return {
      background: `linear-gradient(180deg, ${rgbToHex(lighterRgb)} 0%, ${color} 100%)`
    };
  };
  
  // Helper functions for color manipulation
  const hexToRgb = (hex) => {
    const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
    return result ? {
      r: parseInt(result[1], 16),
      g: parseInt(result[2], 16),
      b: parseInt(result[3], 16)
    } : null;
  };
  
  const rgbToHex = (rgb) => {
    return '#' + [rgb.r, rgb.g, rgb.b].map(x => {
      const hex = x.toString(16);
      return hex.length === 1 ? '0' + hex : hex;
    }).join('');
  };
  
  // Get contrast color for text
  const getContrastColor = (hexColor) => {
    if (!hexColor) return '#1F2937';
    
    const rgb = hexToRgb(hexColor);
    if (!rgb) return '#1F2937';
    
    const brightness = (rgb.r * 299 + rgb.g * 587 + rgb.b * 114) / 1000;
    return brightness > 155 ? '#1F2937' : '#FFFFFF';
  };
  
  // Get activity group info
  const getActivityGroup = (activityId) => {
    return activityGroups.find(ag => ag.id === activityId);
  };
  
  // Get ring info
  const getRing = (ringId) => {
    return rings.find(r => r.id === ringId);
  };
  
  // Format date
  const formatDate = (dateStr) => {
    if (!dateStr) return '';
    try {
      const date = new Date(dateStr);
      const locale = i18n.language === 'sv' ? sv : enUS;
      return format(date, 'd MMM', { locale });
    } catch (e) {
      return dateStr;
    }
  };
  
  return (
    <div className="w-full h-full flex flex-col bg-gradient-to-br from-purple-50 via-pink-50 to-blue-50">
      <style>{`
        .drag-over {
          transform: scale(1.02);
          box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.5), 0 20px 25px -5px rgba(0, 0, 0, 0.1);
          transition: transform 0.15s ease, box-shadow 0.15s ease;
        }
      `}</style>
      {/* Setup Modal */}
      {showSetupModal && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" data-cy="kanban-setup-modal">
          <div className="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6">
            <h2 className="text-2xl font-bold text-gray-900 mb-4">
              V√§lkommen till Kanban-vy
            </h2>
            <p className="text-gray-600 mb-6">
              F√∂r att anv√§nda Kanban-vyn beh√∂ver du etiketter (labels) f√∂r att organisera dina aktiviteter.
              Vill du skapa ett standardupps√§ttning av etiketter?
            </p>
            
            <div className="bg-gray-50 rounded-sm p-4 mb-6">
              <h3 className="font-semibold text-gray-900 mb-3">F√∂reslagna etiketter:</h3>
              <div className="space-y-2">
                {[
                  { name: 'Kanske', color: '#94A3B8' },
                  { name: 'Intressant', color: '#60A5FA' },
                  { name: 'Kommer arbeta p√•', color: '#FBBF24' },
                  { name: 'P√•g√•r', color: '#F59E0B' },
                  { name: 'Klart', color: '#10B981' },
                  { name: 'Avvisat', color: '#EF4444' }
                ].map((label, index) => (
                  <div key={index} className="flex items-center gap-2">
                    <div
                      className="w-4 h-4 rounded"
                      style={{ backgroundColor: label.color }}
                    />
                    <span className="text-sm text-gray-700">{label.name}</span>
                  </div>
                ))}
              </div>
            </div>
            
            <div className="flex gap-3">
              <button
                onClick={() => {
                  localStorage.setItem(`kanban-config-${currentWheelId}`, JSON.stringify({ configured: true }));
                  setShowSetupModal(false);
                }}
                className="flex-1 px-4 py-2 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-sm transition-colors"
                data-cy="kanban-skip-setup"
              >
                Hoppa √∂ver
              </button>
              <button
                onClick={handleCreateDefaultLabels}
                className="flex-1 px-4 py-2 text-white bg-blue-600 hover:bg-blue-700 rounded-sm transition-colors font-medium"
                data-cy="kanban-create-labels"
              >
                Skapa etiketter
              </button>
            </div>
          </div>
        </div>
      )}
      
      {/* Kanban Board */}
      <div className="flex-1 overflow-x-auto overflow-y-hidden p-6">
        <div className="flex gap-4 h-full min-w-max">
          {/* Render columns in order (unlabeled first, then labels) */}
          {orderedColumns.map(column => {
            if (column.type === 'unlabeled') {
              // Unlabeled Column
              const items = itemsByLabel.get('unlabeled') || [];
              const isCollapsed = collapsedColumnsRef.current['unlabeled'];
              
              return (
                <div
                  key="unlabeled"
                  className={`flex-shrink-0 flex flex-col bg-gray-100 rounded-sm shadow-lg overflow-hidden transition-all duration-300 ${
                    isCollapsed ? 'w-16' : 'w-80'
                  }`}
                  onDragOver={(e) => {
                    handleColumnDragOver(e, 'unlabeled');
                    if (draggedItemRef.current) handleDragOver(e, 'unlabeled');
                  }}
                  onDragLeave={handleDragLeave}
                  onDrop={(e) => {
                    if (draggedColumnRef.current) {
                      handleColumnDrop(e, 'unlabeled');
                    } else if (draggedItemRef.current) {
                      handleDrop(e, 'unlabeled');
                    }
                  }}
                  data-cy="kanban-column"
                  data-label-id="unlabeled"
                  data-label-name="Utan etikett"
                >
                  <div
                    draggable
                    onDragStart={(e) => handleColumnDragStart(e, 'unlabeled')}
                    onDragEnd={handleColumnDragEnd}
                    className="relative flex items-center justify-center cursor-grab active:cursor-grabbing bg-gray-300 text-gray-800"
                    onClick={() => toggleColumn('unlabeled')}
                    style={{
                      minHeight: isCollapsed ? '180px' : '80px',
                      padding: isCollapsed ? '16px 8px' : '20px 16px'
                    }}
                  >
                    {isCollapsed ? (
                      <div className="flex flex-col items-center justify-center gap-3 w-full h-full">
                        <div className="writing-mode-vertical transform rotate-180 text-center">
                          <span className="font-bold text-sm uppercase tracking-wider whitespace-nowrap">
                            {t('common.unlabeled', 'Utan etikett')}
                          </span>
                        </div>
                        <div className="flex items-center justify-center min-w-[28px] h-7 rounded-full bg-white/50 backdrop-blur-sm px-2">
                          <span className="text-sm font-bold">{items.length}</span>
                        </div>
                      </div>
                    ) : (
                      <div className="flex items-center justify-between w-full">
                        <div className="flex items-center gap-3">
                          <h3 className="font-bold text-base uppercase tracking-wide">{t('common.unlabeled')}</h3>
                          <div className="flex items-center justify-center min-w-[28px] h-7 rounded-full bg-white/50 backdrop-blur-sm px-2.5">
                            <span className="text-sm font-bold">{items.length}</span>
                          </div>
                        </div>
                        <button
                          onClick={(e) => {
                            e.stopPropagation();
                            toggleColumn('unlabeled');
                          }}
                          className="hover:bg-white/20 p-1.5 rounded transition-colors"
                          aria-label="Minimera kolumn"
                        >
                          <ChevronDown size={20} />
                        </button>
                      </div>
                    )}
                  </div>
                  
                  {!isCollapsed && (
                    <div className="flex-1 overflow-y-auto p-3 space-y-3">
                      {items.map(item => {
                        const activityGroup = getActivityGroup(item.activityId);
                        const ring = getRing(item.ringId);
                        
                        return (
                          <div
                            key={item.id}
                            draggable
                            onDragStart={(e) => {
                              e.stopPropagation();
                              handleDragStart(e, item);
                            }}
                            onDragEnd={handleDragEnd}
                            onClick={(e) => {
                              const rect = e.currentTarget.getBoundingClientRect();
                              setTooltipPosition({ x: rect.right + 10, y: rect.top });
                              setEditingItem(item);
                            }}
                            className="bg-white rounded-sm shadow-md p-4 cursor-move hover:shadow-xl hover:scale-105"
                            data-cy="kanban-card"
                            data-item-id={item.id}
                            data-item-name={item.name}
                          >
                            <h4 className="font-semibold text-gray-900 mb-2">{item.name}</h4>
                            
                            {item.description && (
                              <p className="text-sm text-gray-600 mb-3 line-clamp-2">
                                {item.description}
                              </p>
                            )}
                            
                            <div className="space-y-2">
                              {activityGroup && (
                                <div className="flex items-center gap-2">
                                  <div
                                    className="w-3 h-3 rounded-full"
                                    style={{ backgroundColor: activityGroup.color }}
                                  />
                                  <span className="text-xs text-gray-600">{activityGroup.name}</span>
                                </div>
                              )}
                              
                              {ring && (
                                <div className="text-xs text-gray-500">
                                  üìç {ring.name}
                                </div>
                              )}
                              
                              <div className="flex items-center gap-2 text-xs text-gray-500">
                                <span>{formatDate(item.startDate)}</span>
                                <span>‚Üí</span>
                                <span>{formatDate(item.endDate)}</span>
                              </div>
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  )}
                </div>
              );
            }
            
            // Label Column
            const label = column.label;
            const items = itemsByLabel.get(label.id) || [];
            const isCollapsed = collapsedColumnsRef.current[label.id];
            
            return (
              <div
                key={label.id}
                draggable
                onDragStart={(e) => handleColumnDragStart(e, label.id)}
                onDragEnd={handleColumnDragEnd}
                className={`flex-shrink-0 flex flex-col rounded-sm shadow-lg overflow-hidden transition-all duration-300 cursor-move ${
                  isCollapsed ? 'w-16' : 'w-80'
                }`}
                style={isCollapsed ? {} : getColumnGradient(label.color)}
                onDragOver={(e) => {
                  handleColumnDragOver(e, label.id);
                  if (draggedItemRef.current) handleDragOver(e, label.id);
                }}
                onDragLeave={handleDragLeave}
                onDrop={(e) => {
                  if (draggedColumnRef.current) {
                    handleColumnDrop(e, label.id);
                  } else if (draggedItemRef.current) {
                    handleDrop(e, label.id);
                  }
                }}
                data-cy="kanban-column"
                data-label-id={label.id}
                data-label-name={label.name}
              >
                {/* Column Header */}
                <div
                  className="relative flex items-center justify-center cursor-grab active:cursor-grabbing"
                  onClick={() => toggleColumn(label.id)}
                  style={{
                    backgroundColor: label.color,
                    color: getContrastColor(label.color),
                    minHeight: isCollapsed ? '180px' : '80px',
                    padding: isCollapsed ? '16px 8px' : '20px 16px'
                  }}
                >
                    {isCollapsed ? (
                      <div className="flex flex-col items-center justify-center gap-3 w-full h-full">
                        <div className="writing-mode-vertical transform rotate-180 text-center">
                          <span className="font-bold text-sm uppercase tracking-wider whitespace-nowrap">
                            {label.name}
                          </span>
                        </div>
                        <div className="flex items-center justify-center min-w-[28px] h-7 rounded-full bg-white/30 backdrop-blur-sm px-2">
                          <span className="text-sm font-bold">{items.length}</span>
                        </div>
                      </div>
                    ) : (
                      <div className="flex items-center justify-between w-full">
                        <div className="flex items-center gap-3">
                          <h3 className="font-bold text-base uppercase tracking-wide">{label.name}</h3>
                          <div className="flex items-center justify-center min-w-[28px] h-7 rounded-full bg-white/30 backdrop-blur-sm px-2.5">
                            <span className="text-sm font-bold">{items.length}</span>
                          </div>
                        </div>
                        <button
                          onClick={(e) => {
                            e.stopPropagation();
                            toggleColumn(label.id);
                          }}
                          className="hover:bg-white/20 p-1.5 rounded transition-colors"
                          aria-label="Minimera kolumn"
                        >
                          <ChevronDown size={20} />
                        </button>
                      </div>
                    )}
                  </div>
                  
                  {/* Column Content */}
                  {!isCollapsed && (
                    <div className="flex-1 overflow-y-auto p-3 space-y-3">
                      {items.map(item => {
                        const activityGroup = getActivityGroup(item.activityId);
                        const ring = getRing(item.ringId);
                        
                        return (
                          <div
                            key={item.id}
                            draggable
                            onDragStart={(e) => {
                              e.stopPropagation();
                              handleDragStart(e, item);
                            }}
                            onDragEnd={handleDragEnd}
                            onClick={(e) => {
                              const rect = e.currentTarget.getBoundingClientRect();
                              setTooltipPosition({ x: rect.right + 10, y: rect.top });
                              setEditingItem(item);
                            }}
                            className="bg-white rounded-sm shadow-md p-4 cursor-move hover:shadow-xl hover:scale-105"
                            data-cy="kanban-card"
                            data-item-id={item.id}
                            data-item-name={item.name}
                          >
                            <h4 className="font-semibold text-gray-900 mb-2">{item.name}</h4>
                            
                            {item.description && (
                              <p className="text-sm text-gray-600 mb-3 line-clamp-2">
                                {item.description}
                              </p>
                            )}
                            
                            <div className="space-y-2">
                              {activityGroup && (
                                <div className="flex items-center gap-2">
                                  <div
                                    className="w-3 h-3 rounded-full"
                                    style={{ backgroundColor: activityGroup.color }}
                                  />
                                  <span className="text-xs text-gray-600">{activityGroup.name}</span>
                                </div>
                              )}
                              
                              {ring && (
                                <div className="text-xs text-gray-500">
                                  üìç {ring.name}
                                </div>
                              )}
                              
                              <div className="flex items-center gap-2 text-xs text-gray-500">
                                <span>{formatDate(item.startDate)}</span>
                                <span>‚Üí</span>
                                <span>{formatDate(item.endDate)}</span>
                              </div>
                            </div>
                          </div>
                        );
                      })}
                      
                      {/* Add Item Button */}
                      <button
                        onClick={() => setAddItemLabelId(label.id)}
                        className="w-full py-3 border-2 border-dashed border-white/30 rounded-sm hover:border-white/60 hover:bg-white/10 transition-all flex items-center justify-center gap-2 text-white/70 hover:text-white"
                        data-cy="kanban-add-item"
                        data-label-id={label.id}
                      >
                        <Plus size={18} />
                        <span className="text-sm font-medium">L√§gg till</span>
                      </button>
                    </div>
                  )}
                </div>
              );
            })}
        </div>
      </div>
      
      {/* Item Tooltip (Details/Comments) */}
      {editingItem && (
        <ItemTooltip
          item={editingItem}
          wheelStructure={wheelStructure}
          position={tooltipPosition}
          onEdit={() => {
            // Optionally navigate to wheel or open a full edit modal
            if (onNavigateToItemOnWheel) {
              onNavigateToItemOnWheel(editingItem);
            }
          }}
          onDelete={async () => {
            if (onDeleteItem) {
              await onDeleteItem(editingItem);
            }
            setEditingItem(null);
          }}
          onClose={() => setEditingItem(null)}
          wheel={{ id: currentWheelId }}
        />
      )}
      
      {/* Add Item Modal */}
      {addItemLabelId && (
        <AddItemModal
          wheelId={currentWheelId}
          pageId={currentPageId}
          wheelStructure={wheelStructure}
          initialLabelId={addItemLabelId}
          onClose={() => setAddItemLabelId(null)}
          onSave={(newItems) => {
            if (onAddItems) {
              onAddItems(newItems);
            }
            setAddItemLabelId(null);
          }}
        />
      )}
    </div>
  );
};

export default KanbanView;
